# 后端开发指南
最后更新时间: 2025-12-28

---

## 1. 代码结构
``` json
bitnp-ai-vtuber/
├── backend/
│   ├── _examples/              // 示例代码
│   ├── config_types/           // (辅助代码) 配置文件类型定义
│   ├── stream_node/            // (辅助代码) 流节点代码，用于定义流节点的行为模式
│   ├── tokens/                 // (辅助代码) 个人访问令牌 / API KEY 门户
│   ├── prompts/                // (辅助代码) 提示词门户
│   ├── llm_api/                // 大模型 API 接口代码
│   ├── tts/                    // 语音合成代码
│   ├── agent/                  // 智能体代码，用于定义智能体的行为模式（管理大模型、语音合成等资源）
│   ├── tokens/                 // (辅助代码) 个人访问令牌 / API KEY 门户
│   ├── run_server.py           // 服务器运行脚本 (用于前端与智能体之间的通信)
│   ├── run_agent.py            // 智能体运行脚本
```

---

## 2. 服务器接口列表

### 2.1 WebSocket 接口

#### 2.1.1 智能体连接端点
- **URL**: `ws://<服务器地址>:<端口>/ws/agent/{agent_name}`
- **参数**:
  - `agent_name`: 智能体名称（唯一标识符）
- **连接流程**:
  1. 智能体通过WebSocket连接到此端点
  2. 服务器验证agent_name唯一性
  3. 连接成功后，服务器返回连接确认消息
- **支持的消息类型**:
  - **disconnect**: 断开连接请求
    ```json
    {
      "type": "disconnect"
    }
    ```
  - **event**: 发送事件到前端
    ```json
    {
      "type": "event",
      "data": "事件数据内容"
    }
    ```
- **服务器响应**:
  - 连接成功
    ```json
    {
      "type": "system",
      "message": "successfully connected",
      "client_id": "客户端唯一ID",
      "timestamp": "连接时间戳"
    }
    ```
  - 操作结果
    ```json
    {
      "type": "success",
      "message": "操作结果描述"
    }
    ```
    ```json
    {
      "type": "error",
      "message": "错误信息描述"
    }
    ```

#### 2.1.2 前端连接端点
- **URL**: `ws://<服务器地址>:<端口>/ws/frontend/{agent_name}`
- **参数**:
  - `agent_name`: 要连接的智能体名称
- **连接流程**:
  1. 前端通过WebSocket连接到此端点
  2. 服务器记录连接信息
  3. 连接成功后，服务器返回连接确认消息
- **支持的消息类型**:
  - **disconnect**: 断开连接请求
    ```json
    {
      "type": "disconnect"
    }
    ```
  - **is_agent_online**: 查询智能体是否在线
    ```json
    {
      "type": "is_agent_online"
    }
    ```
  - **event**: 发送事件到智能体
    ```json
    {
      "type": "event",
      "data": {"事件数据内容"}
    }
    ```
- **服务器响应**:
  - 连接成功
    ```json
    {
      "type": "system",
      "message": "successfully connected",
      "client_id": "客户端唯一ID",
      "timestamp": "连接时间戳"
    }
    ```
  - 操作结果
    ```json
    {
      "type": "success",
      "message": true  // 示例：is_agent_online查询结果
    }
    ```
    ```json
    {
      "type": "error",
      "message": "错误信息描述"
    }
    ```

### 2.2 消息传递机制

#### 2.2.1 智能体 → 前端
1. 智能体发送event消息到服务器
2. 服务器将event消息转发给所有连接到该智能体的前端客户端
3. 前端客户端接收并处理事件

#### 2.2.2 前端 → 智能体
1. 前端发送event消息到服务器
2. 服务器将event消息转发给对应的智能体
3. 智能体接收并处理事件

### 2.3 连接管理

- **同一智能体只能同时连接一个实例**
- **前端可以同时连接多个不同的智能体**
- **连接断开时，服务器自动清理连接信息**
- **服务器会定期检查连接状态，自动断开无效连接**

---

## 3. token 与 prompt 门户
### 3.1 token 门户 (个人访问令牌 / API KEY 门户)
在 `backend/tokens` 下创建 `tokens.json` 文件，用于存储个人访问令牌 / API KEY。 (`tokens.json`会被 git 忽略，不上传至仓库)

示例如下：
``` json
{
  "glm": "your-glm-personal-access-token",
  "dashscope": "your-dashscope-api-key"
}
```

在其他脚本中，通过以下方式获取tokens
``` python
>>> from tokens import get_token
>>> glm_token = get_token("glm")
>>> glm_token
'your-glm-personal-access-token'
```
- 获取智谱清言 (glm) 个人访问令牌的方法请参考 [智谱清言开放平台文档](https://docs.bigmodel.cn/cn/guide/start/quick-start)。
- 获取阿里云百炼平台 (dashscope) API KEY 的方法请参考 [阿里云百炼平台文档](https://bailian.console.aliyun.com/?tab=api#/api)。

### 3.2 prompt 门户 (提示词门户)
在 `backend/prompts` 下创建 `{prompt_name}.txt` 文件，用于存储提示词。

每个文件中只能存储一个提示词，文件名为提示词的名称。

例如创建 `shumeiniang.txt` 文件，内容如下：
``` txt
你是一个网协吉祥物树莓娘，你的任务是回答用户的问题。
```

在其他脚本中，通过以下方式获取提示词
``` python
>>> from prompts import get_prompt
>>> shumeiniang_prompt = get_prompt("shumeiniang")
>>> shumeiniang_prompt
'你是一个网协吉祥物树莓娘，你的任务是回答用户的问题。'
```

---

## 4. llm_api (大模型调用)
`backend/llm_api/abstract_bot.py` 定义了大模型 API 的抽象基类。


采用**事件式异步处理逻辑**。通过 `@self.on` 装饰器注册事件处理函数，通过 `self._dispatch_event` 方法来触发事件处理函数。

其子类需要实现 `respond_to_context` 异步方法，用于处理用户输入并返回模型响应。

子类实现样例见 `backend/llm_api/glm.py`
应用样例见 `backend/_examples/llm_api_test.py`

以上样例需要使用 `glm` 模型需要先获取 `glm` 个人访问令牌。获取方法请参考 [智谱清言开放平台文档](https://docs.bigmodel.cn/cn/guide/start/quick-start)。

---

## 5. tts (语音合成)
### 5.1 抽象基类
`backend/tts/abstract_tts.py` 定义了语音合成服务的抽象基类。

其子类需要实现 `synthesize` 同步方法，用于同步地将文本转换为语音。

其子类还需要实现 `synthesize_stream` 异步方法，用于将文本流式转换为语音。

`self.format` 用于表明输出语音的格式。

### 5.2 Genie TTS

**不支持流式生成！**
在本地运行 Genie (GPT-SoVITS 的优化版本) 语音合成推理引擎。
需要先运行 `uv run tts/genie/setup.py` 来下载相应模型。


### 5.3 Dashscope TTS
调用阿里云百炼平台的实时语音合成 API。对流式生成有较好的支持，但是**需要注册并获取 API KEY**，并且在免费额度耗尽后**会产生费用**。

使用前需要先进行音色复刻，并在之后调用时，将音色id指定为复刻的音色id。

音色复刻与音色列表查询 API 调用代码参考 `backend/tts/dashscope/voice_clone.py`

获取 API KEY 的方法请参考 [阿里云百炼平台文档](https://bailian.console.aliyun.com/?tab=api#/api)。

计费规则请参考 [阿里云百炼平台文档](https://bailian.console.aliyun.com/?tab=doc#/doc/?type=model&url=2987148)。

### 5.4 通用接口
`backend/tts/__init__.py` 实现了语音合成服务实例的通用创建接口。

其他脚本可以通过以下方式创建语音合成服务实例：
``` python
from config_types import Dashscope_TTS_Config
from tts import create_tts

tts_config = Dashscope_TTS_Config(
    api_key="your-dashscope-api-key",
    model="dashscope-tts",
    format="wav",
    voice="zhangsan",
)
tts_instance = create_tts(**tts_config)
```

---

## 6. agent (智能体)
`backend/agent/absctract_agent.py` 定义了智能体的抽象基类。

通过 `self.run` 异步函数运行。

采用**事件式异步处理逻辑**。通过 `@self.on` 装饰器注册事件处理函数，事件处理函数将由来自服务器的 event 触发。

通过 `self.emit` 方法向服务器发送事件。

子类实现样例见 `backend/agent/basic_chatting_agent.py`
